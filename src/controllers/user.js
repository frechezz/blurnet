const { PHOTO_IDS } = require("../constants/media");
const {
  getMainKeyboard,
  getInstructionInlineKeyboard,
  getTariffsInlineKeyboard,
} = require("../keyboards");
const { SUBSCRIPTION_URL } = require("../config");
const { TARIFFS } = require("../constants/tariffs");
const api = require("../services/api"); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à API —Å–µ—Ä–≤–∏—Å
const { hasUsedTrial, markTrialUsed } = require("../data/users");

/**
 * Handles the /start command
 */
async function handleStart(ctx) {
  await ctx.reply(
    "–í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ <b>blurnet</b> üôåüèª - –≤—ã–≥–æ–¥–Ω—ã–π VPN –¥–ª—è –≤—ã—Å—à–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±–µ–∑ –∫–∞–∫–∏—Ö –ª–∏–±–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.\n\n" +
      "–ù–∞—à —Å–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫–∞–∫:\n" +
      "- iOS\n" +
      "- Android\n" +
      "- MacOS\n" +
      "- Windows\n\n" +
      "–ú—ã –æ—Ç–ª–∏—á–∞–µ–º—Å—è –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Ç–µ–º, —á—Ç–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—Å–æ–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ (2.5 –ì–±–∏—Ç/—Å) –∏ —Å–∞–º–æ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –∞ —Ç–∞–∫–∂–µ –Ω–µ –≤–µ–¥–µ–º –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, IP –∞–¥—Ä–µ—Å–æ–≤, –∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–ª–µ–¥–æ–≤.\n\n" +
      "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ!\n\n" +
      "–£ –Ω–∞—Å –∫–∞–∫ –∏ —É –≤—Å–µ—Ö –µ—Å—Ç—å —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞, —Å–ª–µ–¥—É–µ—Ç –∏—Ö —Ç–∞–∫–∂–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –ø—Ä–∏–Ω—è—Ç—å. ",
    { parse_mode: "HTML", reply_markup: getMainKeyboard() },
  );
}

/**
 * Handles the "Instruction" button
 */
async function handleInstruction(ctx) {
  await ctx.replyWithPhoto(PHOTO_IDS.instruction, {
    caption:
      "<b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n" +
      "<blockquote>1. –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏\n" +
      "2. –°–ª–µ–¥—É–π—Ç–µ —É–∫–∞–∑–∞–Ω–∏—è–º –±–æ—Ç–∞\n" +
      "3. –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –æ–ø–ª–∞—Ç–æ–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å: @blurnet_support üí≥\n" +
      "4. –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏: @blurnet_news üì∞</blockquote>",
    parse_mode: "HTML",
    reply_markup: getInstructionInlineKeyboard(),
  });
}

/**
 * Handles the "Start Work" button
 */
async function handleStartWork(ctx) {
  await ctx.replyWithPhoto(PHOTO_IDS.tariffs, {
    caption:
      "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω:\n" +
      "üèÜ12 –º–µ—Å—è—Ü–µ–≤ - <b>–¶–µ–Ω–∞: 1000 ‚ÇΩ</b>\n" +
      "ü•á6 –º–µ—Å—è—Ü–µ–≤ - <b>–¶–µ–Ω–∞: 550 ‚ÇΩ</b>\n" +
      "ü•à3 –º–µ—Å—è—Ü–∞ - <b>–¶–µ–Ω–∞: 280 ‚ÇΩ</b>\n" +
      "ü•â1 –º–µ—Å—è—Ü - <b>–¶–µ–Ω–∞: 100 ‚ÇΩ</b>\n\n" +
      "üåü –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ <b>5 –¥–Ω–µ–π</b>",
    parse_mode: "HTML",
    reply_markup: getTariffsInlineKeyboard(),
  });
}

/**
 * Handles the "Rules" button
 */
async function handleRules(ctx) {
  await ctx.replyWithPhoto(PHOTO_IDS.rules, {
    caption:
      "–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è <b>blurnet</b>\n" +
      "<blockquote>1. <b>–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN –¥–ª—è –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</b>\n" +
      "–ù–∞—à —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –¥–ª—è –æ–±—Ö–æ–¥–∞ –∑–∞–∫–æ–Ω–æ–≤.\n\n" +
      "2. <b>–ù–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</b>\n" +
      "–ó–∞–ø—Ä–µ—â–µ–Ω—ã DDoS-–∞—Ç–∞–∫–∏, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –ü–û, —Ö–∞–∫–µ—Ä—Å–∫–∏–µ –≤–∑–ª–æ–º—ã –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞–Ω–æ—Å—è—â–∏–µ –≤—Ä–µ–¥ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.\n\n" +
      "3. <b>–ó–∞–ø—Ä–µ—â–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</b>\n" +
      "–ê–∫–∫–∞—É–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ.\n\n" +
      "4. <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø</b>\n" +
      "–í —Å–ª—É—á–∞–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤.\n\n" +
      "5. <b>–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π</b>\n" +
      "–ú—ã —Å—Ç—Ä–µ–º–∏–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ, –Ω–æ –Ω–µ –Ω–µ—Å–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–±–æ–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏. (–Ω–æ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –º—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –∏—Ö —Ä–µ—à–∏—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ)</blockquote>\n\n" +
      "–ò—Å–ø–æ–ª—å–∑—É—è <b>blurnet</b>, –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.",
    parse_mode: "HTML",
    reply_markup: getMainKeyboard(),
  });
}

/**
 * Handles tariff selection
 */
async function handleTariffSelection(ctx, tariffKey) {
  const tariff = TARIFFS[tariffKey];
  ctx.session.tariff = tariff.name;
  const userId = ctx.from.id;

  // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const { hasUsedTrial, markTrialUsed } = require("../data/users");

  if (tariffKey === "tariff_trial") {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞–Ω–µ–µ
    if (hasUsedTrial(userId)) {
      return await ctx.reply(
        "‚ùå <b>–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</b>\n\n" +
          "–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–±–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.\n\n" +
          "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤:",
        {
          parse_mode: "HTML",
          reply_markup: require("../keyboards").getTariffsInlineKeyboard(),
        },
      );
    }

    // –î–ª—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –æ–ø–ª–∞—Ç—ã
    const username = `tg_${userId}_${Math.floor(Math.random() * 1000)}`;
    let subscriptionUrl = SUBSCRIPTION_URL; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π URL

    try {
      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ —á–µ—Ä–µ–∑ API
      const userResponse = await api.createUser(username, userId, tariff.name);
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–æ–±–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º —Å–æ–∑–¥–∞–Ω:", userResponse.uuid);

      // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (userResponse.subscriptionUrl) {
        subscriptionUrl = userResponse.subscriptionUrl;
      }

      // –û—Ç–º–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–µ–≥–æ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ API-–≤—ã–∑–æ–≤–∞
      markTrialUsed(userId, ctx.from.username || `user_${userId}`);

      await ctx.reply(
        "<b>–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</b> ‚úÖ\n\n" +
          "–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é\n\n" +
          `üëÄ <a href='${subscriptionUrl}'>–ü–æ–¥–ø–∏—Å–∫–∞</a>`,
        {
          parse_mode: "HTML",
          disable_web_page_preview: true,
          reply_markup: require("../keyboards").getReturnTariffInlineKeyboard(),
        },
      );

      // Notify admin
      await ctx.api.sendMessage(
        require("../config").ADMIN_ID,
        `–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥!\n` +
          `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${ctx.from.username ? "@" + ctx.from.username : "–Ω–µ —É–∫–∞–∑–∞–Ω"}\n` +
          `ID: ${ctx.from.id}`,
      );
    } catch (apiError) {
      console.error(
        "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–±–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º:",
        apiError,
      );

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      await ctx.reply(
        "‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞</b>\n\n" +
          "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.\n" +
          "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤.\n\n" +
          "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @blurnet_support",
        {
          parse_mode: "HTML",
          reply_markup: require("../keyboards").getReturnTariffInlineKeyboard(),
        },
      );

      // Notify admin about error
      await ctx.api.sendMessage(
        require("../config").ADMIN_ID,
        `‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–±–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º!\n` +
          `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${ctx.from.username ? "@" + ctx.from.username : "–Ω–µ —É–∫–∞–∑–∞–Ω"}\n` +
          `ID: ${ctx.from.id}\n` +
          `–û—à–∏–±–∫–∞: ${apiError.message}`,
      );
    }
  } else {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
    await ctx.reply(tariff.message, {
      reply_markup: require("../keyboards").getPaymentInlineKeyboard(),
    });
  }
}

module.exports = {
  handleStart,
  handleInstruction,
  handleStartWork,
  handleRules,
  handleTariffSelection,
};
